# Starlight 기반 문서화 환경 세팅하기

지난 편에서 문서화의 중요성을 강조했으니 이제 실제로 프로젝트 안에서 문서화 환경이 개발 초기부터 필요한 이유를 짧게 짚고 넘어가자.
문서화 환경은 단순히 문서를 만드는 것을 넘어서, 코드와 함께 진화하는 지식 저장소 역할을 한다.
초기부터 체계적인 문서화 환경을 갖추면 개발자들이 변경사항을 쉽게 공유하고, 프로젝트 전반의 이해도를 높이며, 유지보수를 원활하게 할 수 있다.

> 목표
>
> - 문서를 따로 떼어내지 않고 모노레포 안에서 관리
> - `npm run docs:dev`만 치면 문서 사이트 확인 가능
> - GitHub Pages로 자동 배포

## 왜 docs를 별도 패키지로 만들지 않고 루트에서 관리할까?

보통 모노레포에서는 각 기능별로 패키지를 나누지만, 문서화는 프로젝트의 일부이면서도 독립적으로 관리되어야 한다.
따라서 docs를 **워크스페이스에 포함하지 않고**, 루트에 **독립 폴더**로 두는 방식을 추천한다.
이렇게 하면 문서 빌드/배포가 패키지 의존성과 뒤섞이지 않고, 관리가 훨씬 깔끔해진다.
또한 docs를 워크스페이스에서 제외하면 의존성 충돌을 피할 수 있고, 설치 및 빌드 속도가 빨라지는 장점도 있다.

### 디렉터리 구조 제안

```text
/ (repo root)
├─ packages/
│  ├─ core/
│  └─ ... (추가 예정)
├─ docs/                # ← 문서 사이트(별도 패키지 아님, 워크스페이스에 포함 X)
│  ├─ src/
│  │  ├─ content/
│  │  │  ├─ en/
│  │  │  │  ├─ guides/     # How-to, 튜토리얼
│  │  │  │  ├─ concepts/   # 철학/디자인 개념
│  │  │  │  ├─ reference/  # API 레퍼런스(초안)
│  │  │  │  └─ blog/       # 연재글
│  │  │  └─ ko/
│  │  │     ├─ guides/
│  │  │     ├─ concepts/
│  │  │     ├─ reference/
│  │  │     └─ blog/
│  │  └─ components/    # MDX에서 쓰는 경고/팁/코드탭
│  ├─ public/
│  ├─ astro.config.mjs
│  ├─ tsconfig.json
│  ├─ package.json      # (optional: docs만 따로 둘 수도, 루트에 통합도 가능)
│  └─ README.md
├─ .github/
│  └─ workflows/
│     └─ docs.yml       # GitHub Pages 자동 배포
├─ .prettierrc          # (다음 글: 문서 품질 관리에서 다룸)
├─ .remarkrc.mjs        # (다음 글에서 다룸)
├─ .markdownlint.json   # (다음 글에서 다룸)
├─ package.json
└─ README.md
```

## Astro + Starlight

### Astro + Starlight이란?

- **Astro:** 정적 사이트 생성기(SSG). **Islands Architecture**로 필요한 부분만 JS를 불러와 콘텐츠 중심 사이트에 유리하다.
- **Starlight:** Astro 기반 **문서화 전용 테마/플러그인**. 레이아웃, 내비게이션, 다국어, 검색 등 문서 사이트에 필요한 기본 기능을 제공한다.

### 왜 Astro + Starlight인가?

- **문서 특화 기능:** 가이드/레퍼런스/블로그/다국어/다크 모드 등 기본 제공
- **경량 & 빠른 배포:** 정적 빌드로 Pages/Cloudflare 등에서 안정적
- **생태계 & 생산성:** 템플릿과 예제가 풍부, 셋업이 단순
- **CI 친화적:** GitHub Actions와 궁합이 좋아 자동 배포 파이프라인 구성이 쉽다

### 설치

```bash
# 루트에서 실행
mkdir -p docs && cd docs
npm create astro@latest -- --template starlight
npm i -D @astrojs/sitemap
```

> 설치 중 “프로젝트 생성 디렉터리”를 묻는다면 현재 디렉터리(`.`)를 선택하면 된다.

위 명령은 `docs` 폴더 안에 **Starlight 템플릿이 적용된 Astro 프로젝트**를 초기화한다.

## 루트 package.json에 스크립트 추가

프로젝트 루트에서 문서 사이트를 바로 실행/빌드/미리보기 할 수 있도록 스크립트를 추가한다.

```json
{
  "name": "lynjs",
  "scripts": {
    "docs:dev": "npm --prefix docs run dev",
    "docs:build": "npm --prefix docs run build",
    "docs:preview": "npm --prefix docs run preview"
  }
}
```

- **docs:dev:** 개발 모드로 문서 사이트 실행, 변경사항 HMR
- **docs:build:** 정적 HTML로 빌드(배포 산출물 생성)
- **docs:preview:** 빌드 산출물을 로컬 서버로 미리보기(배포 전 최종 확인)

## Astro + Starlight 설정 파일

Starlight은 Astro 통합(Integration)으로 동작한다. **모든 문서 사이트 설정은 `docs/astro.config.mjs`**에서 관리한다.
여기서 사이트 제목, 소셜 링크, 내비게이션/사이드바 등을 선언하면 Starlight이 기본 레이아웃과 UI를 자동으로 렌더링한다.

#### docs/astro.config.mjs

```js
import { defineConfig } from 'astro/config';
import starlight from '@astrojs/starlight';
import sitemap from '@astrojs/sitemap';
import process from 'node:process';

// https://astro.build/config
export default defineConfig({
  // 정적 자산과 내부 링크에 붙는 prefix
  // GitHub Pages 같은 하위 디렉토리(/lynjs/…) 배포에서 필수
  base: process.env.DOCS_BASE || '/',

  integrations: [
    sitemap(),

    starlight({
      title: 'LynJS Documentation',

      social: [{ icon: 'github', label: 'GitHub', href: 'https://github.com/lynjs-dev/lynjs' }],

      sidebar: [
        {
          label: 'Guides',
          items: [{ label: 'Example Guide', slug: 'guides/example' }],
        },
        {
          label: 'Reference',
          autogenerate: { directory: 'reference' },
        },
      ],
    }),
  ],
});
```

- **site/base:** GitHub Pages에서 자주 생기는 404/경로 깨짐을 방지한다(필수).
- **title/social:** 헤더와 탭 제목, 우상단 소셜 아이콘 설정.
- **sidebar:** 수동 `items` 또는 디렉터리 기반 `autogenerate`로 사이드바 구성.

> 이 설정만으로도 `npm run docs:dev`로 즉시 개발 서버를 띄우고, `npm run docs:build` 결과물로 Pages 배포가 가능하다.

## 자동배포

문서는 살아있는 시스템이다. 수시로 업데이트되고 최신 상태를 유지해야 한다.
CI/CD 자동 배포를 설정하면, 개발자가 직접 배포하지 않아도 변경이 곧바로 반영되어 사용자에게 노출된다.
특히 GitHub Pages 같은 정적 호스팅 환경에서는 **수동 배포 없이 항상 최신 상태**를 유지하는 것이 중요하다.

### Github 설정

settings > pages > Build and deployment > source : GitHub actions 선택
settings > environments > github-pages > Deployment branches and tags : main, next

**.github/workflows/docs.yml**

> 아래 예시는 브랜치/태그 이벤트를 모두 처리하고, **브랜치/태그별 디렉터리로 빌드 결과를 모아 업로드**하는 패턴이다.

```yaml
name: Deploy Docs

on:
  push:
    branches: [main, next]
    paths:
      - 'docs/**'
      - '.github/workflows/docs.yml'
    tags: ['v*']
  workflow_dispatch: {}

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - uses: actions/setup-node@v4
        with: { node-version: 20 }
      - run: npm ci
      - run: npm --prefix docs ci

      - name: Build docs
        run: |
          set -e

          BRANCH="${GITHUB_REF_NAME}"
          echo "Branch name : ${BRANCH}"

          # 브랜치 이름 정규화 (슬래시 등 안전치환)
          BRANCH_SAFE=$(echo "$BRANCH" | tr '/ #' '---' | sed 's/[^A-Za-z0-9._-]/-/g')

          if [ "$BRANCH" = "main" ]; then
            # main 브랜치는 /lynjs 루트에 배포
            export DOCS_BASE="/lynjs"
            OUT_DIR="out"
          else
            # 그 외 브랜치는 /lynjs/<branch>
            export DOCS_BASE="/lynjs/${BRANCH_SAFE}"
            OUT_DIR="out/${BRANCH_SAFE}"
          fi

          echo "DOCS_BASE=${DOCS_BASE}"
          echo "OUT_DIR=${OUT_DIR}"

          # 빌드 (astro.config.mjs 에서 process.env.DOCS_BASE 사용)
          npm run docs:build

          mkdir -p "$OUT_DIR"
          cp -r docs/dist/* "$OUT_DIR/"

          echo "BRANCH=${BRANCH}" >> $GITHUB_ENV
          echo "BRANCH_SAFE=${BRANCH_SAFE}" >> $GITHUB_ENV

      - name: Debug artifact tree
        run: |
          echo "== list out =="
          find out -maxdepth 3 -type f | sort
          if [ "$BRANCH" = "main" ]; then
            test -f "out/index.html" || (echo "index.html missing"; exit 1)
          else
            test -f "out/${BRANCH_SAFE}/index.html" || (echo "index.html missing"; exit 1)
          fi

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: out

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - id: deployment
        uses: actions/deploy-pages@v4
```

> **GitHub Pages 설정**
>
> - Repository → Settings → Pages → _Build and deployment_ = **GitHub Actions**
> - `docs/astro.config.mjs`의 `site`, `base`를 리포지토리에 맞게 설정

## 대규모 문서화에서 흔히 필요한 기능

문서가 많아질수록 **검색/버전/다국어**는 필수가 된다.
필요 시 점진적으로 도입하되, 이 글에서는 **기본 셋업**에 집중한다.

- 검색: 사용자가 원하는 정보를 빠르게 탐색
- 버전: 릴리스별 문서 보존
- 다국어: 글로벌 사용자 대상 문서 제공

### Starlight에서 버전 디렉터리 구조

Starlight는 기본 버전 기능이 없다. 대신 **폴더 구조 + 사이드바 설정**으로 버전을 구분한다.

```
docs/
└─ src/content/
   ├─ latest/
   ├─ v1/
   └─ v1.2/
```

`starlight` 사이드바 예시:

```js
export const sidebar = {
  '/latest/': [{ text: '시작하기', link: '/latest/guides/getting-started' }],
  '/v1/': [{ text: '시작하기 (v1)', link: '/v1/guides/getting-started' }],
};
```

> 실제 운영에서는 **소스 복사 없이**, 태그 기준 체크아웃으로 빌드한 결과만 `/vX` 경로에 업로드하는 방식을 추천한다.

## 글감 파이프라인

문서 작성은 지속적이어야 한다.
`/docs/src/content/_drafts/` 폴더를 운영하면 초안-리뷰-게시 과정을 분리할 수 있어 부담 없이 점진적으로 개선하는 문서 문화가 자리 잡는다.
PR에 문서 체크를 필수로 하고, 릴리스 시 CHANGELOG/블로그 포스트 자동 생성 워크플로우도 고려하자.

## 더 생각 해봐야 할것들

- 문서 품질 자동화 심화: 링크 체커, 이미지 크기 검사, 용어집/스타일 가이드
- Pagefind 검색 붙이기
- 다국어(i18n) 운영 전략과 내비게이션 구성 베스트 프랙티스
