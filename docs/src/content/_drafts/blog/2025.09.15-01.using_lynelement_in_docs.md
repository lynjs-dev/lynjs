# Astro에서 LynJS 사용하기

문서를 작성할 때 단순히 코드 블록만 보여주는 것보다, **실제 코드가 실행된 결과**까지 함께 보여줄 수 있다면 독자가 훨씬
쉽게 이해할 수 있다. 이렇게 하면 문서와 코드가 분리되지 않고 항상 **일관성**을 유지할 수 있으며, 작성한 코드가 실제로
동작하는지까지 자연스럽게 검증된다. 결과적으로 문서의 품질은 높아지고, 예제 코드 관리도 훨씬 단순해진다.

이런 이유로 예제 코드를 문서 안에 직접 복사해 붙여 넣는 대신, **별도의 예제 코드 파일**을 작성한 뒤 MDX 문서에서 이를
`import`하여 사용하는 방식을 시도한다. 이렇게 하면 코드와 문서가 항상 연결되어 유지되고, 예제 수정 시 문서도 자동으로
최신 상태를 반영하게 된다.

## 첫 번째 예제 문서: `api/components/define`

가장 첫 번째 예제로 선택한 문서는 **`api/components/define`**이다. 현재 LynElement는 `render()` 함수만 설계된 상태이며,
이 기본 기능을 설명하기 위해 가장 단순한 컴포넌트를 만들어 본다.

- 목표: LynElement를 상속받아 최소한의 `render()`를 구현한 예제를 작성
- 방법: `examples/api/components/define/define.ts`에 실제 예제 코드를 두고, 문서 파일
  `docs/en/api/components/define.md`에서 이를 불러와 실행 결과를 함께 확인

이 문서는 LynElement의 **가장 기초적인 사용법**을 보여주는 동시에, “예제 코드 → 문서 import → 문서에서 바로 실행”이라는
문서 작성 방식을 검증하기 위한 출발점이 된다.

## Example 작성

먼저 LynJS의 가장 기본적인 사용법을 보여주는 예제로, `LynElement`를 상속한 간단한 컴포넌트를 정의한다. 이 컴포넌트는
`render()` 메서드에서 단순히 `<p>` 태그 하나를 생성하고, 해당 태그에 문자열을 넣어 반환한다. 마지막으로
`customElements.define`을 통해 브라우저에 등록하면, 이제 HTML 어디서든 `<my-element>`라는 태그로 이 컴포넌트를 사용 할
수 있다.

**docs/src/examples/api/components/define/define.ts**

```ts
import { LynElement } from '@lynjs/core';

export class MyElement extends LynElement {
  render() {
    const el = document.createElement('p');
    el.innerText = 'Hello from MyElement!';
    return el;
  }
}

customElements.define('my-element', MyElement);
```

이 코드의 핵심 의도는 다음과 같다:

- `MyElement`라는 클래스를 정의하고 LynElement를 상속받는다.
- `render()` 안에서 새로운 DOM 요소(`<p>`)를 만들어 반환한다.
- `customElements.define('my-element', MyElement)`를 통해 `<my-element>`라는 태그 이름을 브라우저에 등록한다.

**/docs/src/content/docs/en/api/components/define.html**

```html
<my-element></my-element>
```

이 예제 파일을 mdx파일 에서 import 하고 `<my-element />`를 작성해 실행 결과를 확인할 수 있기를 기대한다.

## 문서에 example 파일 코드 삽입하기

### CodeBlock 컴포넌트 만들기

Astro + Starlight에서는 @astrojs/starlight/components가 제공하는 \<Code\>, \<Tabs\>, \<TabItem\> 컴포넌트를 활용할 수
있다. \<Code\>를 직접 사용해도 되지만, 여러 파일을 동시에 보여주거나 확장성을 고려하여 확장 컴포는트를 만든다.

아래 예제는 출력하고 싶은 파일 경로를 sources라는 배열 props를 받아, 전달된 파일들을 탭(Tab) 형태로 나열하고 각 파일
내용을 하이라이트된 코드 블록으로 렌더링한다.

**/docs/src/components/CodeBlock.astro**

```astro
---
import { Code, Tabs, TabItem } from '@astrojs/starlight/components';
import path from 'node:path'

export interface Props {
  sources: string[];
}

const { sources, preview } = Astro.props;
const files = import.meta.glob('/src/**/*', { as: 'raw' , eager:true});

function getCode(file: string): string {
  return file in files ? files[file]: 'file not found: ${file}';
}

function getFileName(file: string): string{
  return file.split(path.sep).at(-1) as string;
}

function getExtension(file: string): string{
  return file.split('.').at(-1) as string;
}

---

<div>
  <Tabs>
    {sources.map(source =>
      <TabItem label={getFileName(source)}>
        <Code code={getCode(source)} lang={getExtension(source)}/>
      </TabItem>
    )}
  </Tabs>
</div>
```

### mdx 에서 CodeBlock 사용

**/docs/src/content/docs/en/api/components/define.mdx**

```mdx
---
title: 커스텀 엘리먼트 정의하기
---

LynJS에서 커스텀 엘리먼트는 `LynElement`를 상속받아 정의합니다. 이렇게 정의된 클래스는 브라우저의 **Custom Elements
Registry**에 등록되어, 표준 웹 컴포넌트로 동작합니다. 이 방식은 컴포넌트를 표준에 맞게 유지하면서, 어떤 프로젝트에서도
쉽게 재사용할 수 있도록 합니다.

import CodeBlock from '/src/components/CodeBlock.astro';

<CodeBlock
  sources={['/src/examples/api/components/define/define.ts', '/src/examples/api/components/define/define.html']}
/>

- `LynElement`는 생명주기, 렌더링, 세밀한 반응성 기능을 제공하는 기본 클래스입니다.
- `customElements.define`는 해당 클래스를 브라우저에 커스텀 엘리먼트로 등록합니다.
```

## 문서에서 Custom element 사용 (`define.md`)

소스 목록이 탭 형태로 잘 출력되는 것을 확인했으니, 이제 **코드가 문서 안에서 그대로 보이고(탭)**, 선택 시 **미리보기까지
렌더**되도록 구성한다. 이를 위해 `CodeBlock` 컴포넌트에 `preview` props를 추가해, 전달받은 HTML 파일을 실제로
렌더링한다.

### CodeBlock.astro 미리보기 추가

**/docs/src/components/CodeBlock.astro**

```astro
---
import { Code, Tabs, TabItem } from '@astrojs/starlight/components';
import path from 'node:path'

export interface Props {
  sources: string[];   // 탭으로 보여줄 소스 파일 목록
  preview?: string;    // 실제로 렌더할 HTML 파일(선택)
  runtime?: string;    // 브라우저에서 import할 TS 모듈 경로(선택)
}

const { sources, preview } = Astro.props;

// 파일 내용을 "문자열"로 동기 로드 (Vite: eager + as:'raw')
const files = import.meta.glob('/src/**/*', { as: 'raw' , eager:true});

function getCode(file: string): string {
  return file in files ? (files as Record<string, string>)[file] : `file not found: ${file}`;
}

// 탭 라벨은 파일명만 노출
function getFileName(file: string): string{
  // 크로스 플랫폼 안전: path.basename 사용 권장
  return path.basename(file);
}

// 하이라이트 언어는 확장자 기반 추정
function getExtension(file: string): string{
  return file.split('.').at(-1) as string;
}

// runtime 모듈 경로 결정: props.runtime 우선, 없으면 sources에서 .ts/.tsx 첫 항목 사용
const runtimeModule =
  runtime ??
  sources.find((s) => /\.(ts|tsx)$/.test(s)) ??
  '';
---

<div>
  <Tabs>
    {sources.map(source =>
      <TabItem label={getFileName(source)}>
        <Code code={getCode(source)} lang={getExtension(source)} />
      </TabItem>
    )}
  </Tabs>

  {preview && (
    <div>
      {/* HTML 내용을 실제 DOM으로 렌더 */}
      <div set:html={getCode(preview)} />
    </div>
  )}
</div>

{/*
  브라우저에서만 TS 모듈을 동적 import → 커스텀 엘리먼트 등록 보장
  서버에서 직렬화한 경로(runtimeModule)를 클라이언트로 안전하게 전달
*/}
{runtimeModule && (
<script type="module" define:vars={{ runtimeModule }}>
  if (runtimeModule) {
    // Vite 정적 분석을 피하기 위해 vite-ignore 사용
    await import(/* @vite-ignore */ runtimeModule);
  }
</script>
  )}
```

### define.mdx에서 custom element 사용

preview에는 <my-element></my-element> 같은 사용 예 HTML이 들어간다. 이 HTML 요소가 정상적으로 동작하려면 브라우저
환경에서 해당 태그가 이미 Custom Elements Registry에 등록되어 있어야 한다. 따라서 예제 TS 파일(define.ts)을 문서에서
함께 import하여 번들에 포함시키고, 브라우저 로드 시점에 커스텀 엘리먼트가 자동으로 등록되도록 한다.

```mdx
---
title: 커스텀 엘리먼트 정의하기
---

LynJS에서 커스텀 엘리먼트는 `LynElement`를 상속받아 정의합니다. 이렇게 정의된 클래스는 브라우저의 **Custom Elements
Registry**에 등록되어, 표준 웹 컴포넌트로 동작합니다. 이 방식은 컴포넌트를 표준에 맞게 유지하면서, 어떤 프로젝트에서도
쉽게 재사용할 수 있도록 합니다.

import CodeBlock from '/src/components/CodeBlock.astro';
// 커스텀 엘리먼트 등록(define)을 위해 예제 TS를 함께 번들에 포함
import '/src/examples/api/components/define/define.ts';

<CodeBlock
  sources={['/src/examples/api/components/define/define.ts']}
  preview="/src/examples/api/components/define/define.html"
/>

- `LynElement`는 생명주기, 렌더링, 세밀한 반응성 기능을 제공하는 기본 클래스입니다.
- `customElements.define`는 해당 클래스를 브라우저에 커스텀 엘리먼트로 등록합니다.
```
