# lint & Prettier 설정

## lint

lint(린트)는 코드 속에서 문제 될 수 있는 패턴을 자동으로 잡아주는 정적 분석 도구다. 사용하지 않는 변수, 느슨한 비교로
인한 버그 가능성, 타입스크립트의 `any` 남용 같은 것들을 규칙으로 걸러낸다. 팀(혹은 프로젝트) 공통 기준을 코드로 선언해
**일관된 품질**을 유지하는 게 핵심이다.

## Prettier

Prettier는 **포맷팅 전용**이다. 세미콜론, 들여쓰기, 따옴표 스타일 같은 “모양새”만 자동으로 통일한다. 핵심 철학은
간단하다: **스타일 논쟁은 기계에 맡기자.**

## 함께 쓰는 이유

- **ESLint:** 코드 품질/버그 가능성에 집중
- **Prettier:** 코드 스타일(포맷) 담당 두 영역이 겹치는 부분은 `eslint-config-prettier`로 **ESLint의 포맷 관련 규칙을
  비활성화**해 충돌을 없앤다.

## LynJS 모노레포에서의 목표

- 타입스크립트 기반, 번들링 없이 가벼운 구성
- 루트에 **공용 설정**을 두고 패키지는 별도 이유 없으면 이를 상속
- 저장 시 자동 포맷/린트, 커밋 전에 **빠른 품질 체크**(옵션)

## ESLint 설정(ESLint v9 Flat Config)

ESLint v9부터는 **flat config**(`eslint.config.js`)가 권장된다. 단일 파일에서 배열로 설정 블록을 나열하므로 구조가
명확하고, `import/export`를 그대로 쓸 수 있다.

### 설치

```bash
npm i -D eslint prettier @eslint/js typescript-eslint eslint-config-prettier eslint-plugin-prettier
```

- **eslint:** 린트 엔진
- **prettier:** 코드 포맷터. 세미콜론, 따옴표, 줄바꿈 등 스타일을 자동 통일
- **@eslint/js:** JS 권장 규칙(Flat Config 대응)
- **typescript-eslint:** TS 파서 + 규칙
- **eslint-config-prettier:** Prettier와 충돌하는 규칙 끄기
- **eslint-plugin-prettier:** Prettier를 규칙으로 실행(위반 시 경고/에러)

### 설정 파일 작성

프로젝트 루트에 `eslint.config.js`, `.prettierrc`, `.prettierignore`를 둔다.

**eslint.config.js**

```js
// eslint.config.js
import { cwd } from 'node:process';
import js from '@eslint/js';
import ts from 'typescript-eslint';
import prettier from 'eslint-config-prettier';
import eslintPluginPrettier from 'eslint-plugin-prettier';

export default [
  // 1) JS 권장
  js.configs.recommended,

  // 2) TS 권장(타입기반 규칙은 꺼둔 기본 recommended)
  ...ts.configs.recommended,

  // 3) Prettier와 충돌하는 규칙 끄기
  prettier,

  // 4) 전역 ignore & 공통 룰
  {
    ignores: [
      '**/node_modules/**',
      '**/dist/**',
      '**/coverage/**',
      '**/*.d.ts',
      'docs/astro/**',
      // 필요 시 설정 파일 전역 무시도 가능:
      // '**/*.config.js', '**/*.config.cjs', '**/*.config.mjs',
    ],
  },
  {
    plugins: { prettier: eslintPluginPrettier },
    rules: {
      'prettier/prettier': 'error',
      '@typescript-eslint/no-unused-vars': [
        'error',
        {
          argsIgnorePattern: '^_',
          varsIgnorePattern: '^_',
        },
      ],
      '@typescript-eslint/no-explicit-any': 'warn',
    },
  },

  // 5) 타입 인지 없이 빠른 TS 린트
  {
    files: ['{src,packages/*}/**/*.{ts,tsx}'],
    languageOptions: {
      parser: ts.parser,
      parserOptions: {
        project: [
          './tsconfig.json', // 루트
          './packages/*/tsconfig.json', // 모든 패키지
        ],
        tsconfigRootDir: cwd(),
      },
    },
  },

  // 6) 테스트 파일 ESLint 적용 완화
  {
    files: ['**/*.test.ts', '**/*.test.tsx'],
    rules: { '@typescript-eslint/no-explicit-any': 'off' },
  },

  // 7) Node 환경이 필요한 설정 파일들만 별도 적용
  {
    files: ['*.config.cjs', '*.config.mjs', '.releaserc.cjs', 'commitlint.config.cjs'],
    languageOptions: {
      globals: {
        module: 'readonly',
        process: 'readonly',
        require: 'readonly',
      },
    },
  },
];
```

> **타입 기반 린트가 필요해지면** `typescript-eslint`의 `recommendedTypeChecked` 조합으로 올리고,
> `parserOptions.project`를 유지한 채 필요한 규칙만 추가하면 된다. (성능 비용 ↑)

**.prettierrc**

```json
{
  "printWidth": 120,
  "proseWrap": "always",
  "tabWidth": 2,
  "singleQuote": true,
  "trailingComma": "all",
  "semi": true,
  "bracketSpacing": true,
  "bracketSameLine": false,
  "arrowParens": "always",
  "endOfLine": "lf",
  "quoteProps": "consistent"
}
```

**.prettierignore**

```ignore
**/node_modules/**
**/dist/**
**/coverage/**
docs/astro/**
CHANGELOG.md
```

## 에디터 기본값(.editorconfig)

여러 에디터에서 **기본 스타일을 통일**해 불필요한 diff를 줄인다.

**.editorconfig**

```editorconfig
root = true

[*]
indent_style = space
indent_size = 2
charset = utf-8
end_of_line = lf
insert_final_newline = true
trim_trailing_whitespace = true
```

## VSCode에서 저장 시 자동 포맷

**.vscode/settings.json**

```json
{
  "editor.formatOnSave": true,
  "editor.defaultFormatter": "esbenp.prettier-vscode",
  "editor.codeActionsOnSave": {
    "source.fixAll.eslint": "explicit"
  }
}
```

- 저장하면 Prettier가 포맷 → ESLint가 자동 수정 가능한 룰을 적용

## npm 스크립트

루트 `package.json`에는 다음 스크립트가 추가:

```json
{
  "scripts": {
    "prepare": "husky",
    "lint": "eslint --ext .ts,.tsx,.js,.cjs --report-unused-disable-directives --cache",
    "lint:all": "eslint . --ext .ts,.tsx,.js,.cjs --report-unused-disable-directives",
    "lint:fix": "npm run lint -- --fix --max-warnings=0",
    "format": "prettier . --check --cache",
    "format:fix": "prettier . --write --cache",
    "lint:ws": "npm run lint -ws --if-present",
    "format:ws": "npm run format -ws --if-present"
  }
}
```

- **prepare:** Husky 초기화 스크립트를 실행한다. Git 훅 설정을 자동으로 적용할 수 있게 하여, 커밋 시점에 lint-staged가
  항상 실행되도록 만든다.
- **lint:** 커밋 훅(lint-staged)과 함께 동작하도록 설계된 기본 린트 명령어다. `eslint` 실행 시 `.`(전체 디렉토리)을
  명시하지 않고, 인자로 전달된 파일만 검사한다. 그래서 보통 **변경된 파일만 빠르게 점검**하는 데 쓰인다.
- **lint:all:** 전체 레포지토리를 대상으로 린트를 수행한다. CI/CD 파이프라인이나 로컬에서 **코드 전체를 정밀하게
  점검**할 때 사용한다. 팀원 간 환경 차이 없이 동일한 기준으로 검사하는 데 유용하다.
- **lint:fix:** 자동으로 수정 가능한 문제를 즉시 고쳐준다. 예를 들어 불필요한 세미콜론, 사용하지 않는 import 같은 문제는
  사람이 직접 고치지 않아도 해결된다. `--max-warnings=0` 옵션으로 경고가 있으면 실패하도록 강제해 **품질 기준을 엄격히
  유지 **한다.
- **format:** Prettier를 이용해 코드 전체를 검사하지만 실제 수정은 하지 않는다(`--check`). 주로 CI에서 “포맷팅 규칙을
  어긴 코드가 있는지”를 확인하는 용도로 사용한다.
- **format:fix:** Prettier가 전체 코드를 다시 쓰면서 포맷팅을 자동 적용한다. 들여쓰기, 따옴표, 세미콜론 등 스타일 관련
  문제를 개발자가 직접 수정할 필요가 없다.
- **lint:ws / format:ws:** 워크스페이스 단위로 `lint`와 `format`을 실행한다. 모노레포에서 루트뿐 아니라 각 패키지에도
  동일한 규칙을 전파할 수 있어, 프로젝트 전체 일관성을 보장한다.

### GitHub Actions 워크플로우 수정

Github Actions 워크플로우에서도 lint:all과 format을 실행하도록 `.github/workflows/release.yml`을 아래와 같이 수정한다.

`.github/workflows/release.yml`

```yaml
jobs:
  release:
    steps:
        ...
          - name: Install
            run: npm ci
          - name: Lint all
            run: npm run lint:all
          - name: Format check
            run: npm run format
          ...
```

## 커밋 훅 — Husky + lint-staged (현재 구성)

### lint-staged는 뭐 하는데?

**lint-staged**는 **스테이징된 파일만** 대상으로 명령을 실행한다. 커밋에 포함되지도 않는 파일까지 전부 검사하지 않으니
**빠르고 현실적**이다. Husky의 `pre-commit` 훅에서 lint-staged를 호출하면, 변경된 파일 목록을 자동으로 ESLint/Prettier에
넘겨준다.

### 설치 & 초기화

```bash
npm i -D husky lint-staged
npx husky init
# 생성된 .husky/pre-commit 파일에 다음 한 줄을 추가
# npx lint-staged
```

- `npx husky init`을 실행하면 `.husky/` 디렉터리와 기본 훅 스크립트가 생성된다.
- `pre-commit` 훅에서 `npx lint-staged`를 호출하면, **staged된 파일 목록만** 추려서 우리가 지정한 명령을 실행한다.

### package.json의 lint-staged 설정

```json
{
  "lint-staged": {
    "*.{ts,tsx,js,cjs,mjs}": ["npm run lint:fix"],
    "*.{json,yml,yaml,css,scss,html,md}": ["npm run format:fix"]
  }
}
```

- 커밋할 때 `lint-staged`가 변경된 파일만 추려서 **명령 뒤에 파일 인자로 자동 전달**한다.
  - 예: `npm run lint:fix -- src/a.ts src/b.ts`
- `npm run lint:fix`는 내부적으로 `eslint --fix --max-warnings=0`을 호출하므로,
  - **자동 수리 가능 문제는 즉시 고치고**,
  - 경고가 하나라도 남으면 커밋을 실패시켜 **품질 기준을 강제**한다.
- 문서/설정류(`*.json`, `*.md`, `*.yml` 등)는 `npm run format:fix`로 Prettier 포맷만 적용한다.
- 결과적으로 **전체 레포가 아니라 “staged된 파일만” 빠르게 처리**하므로 커밋 속도를 해치지 않는다.

> 터미널에서 `npm run lint:fix`를 **직접** 실행하면 lint-staged가 파일 인자를 붙여주지 않으므로 범위가 넓어질 수 있다.
> 전체 점검은 `npm run lint:all`을 사용하세요.

### 흐름 요약

1. 파일 수정 → `git add`
2. `git commit` 실행
3. Husky의 `pre-commit` 훅이 `lint-staged`를 호출
4. `lint-staged`가 **staged된 파일만** ESLint/Prettier에 넘겨서
   - 코드: `npm run lint:fix` (자동 고침 + 경고 차단)
   - 문서/설정: `npm run format:fix` (포맷 적용)
5. 문제가 있으면 커밋 **중단**(수정 후 재시도), 통과하면 커밋 **성공**

### 자주 겪는 이슈

- **왜 dist나 node_modules까지 검사하죠?** → `eslint.config.js`의 `ignores`에 `**/dist/**`, `**/node_modules/**`가
  포함되어 있어야 한다. 전역 `eslint .` 대신 staged 파일만 처리하는 `lint-staged`를 쓰면 잡음이 줄어든다.

- **브랜치마다 훅이 달라요** → Husky 설정은 레포에 포함되므로 **브랜치별로도 버전 관리**된다. 브랜치를 바꾸면 해당
  브랜치의 훅이 적용된다.

- **CI에서는 어떻게?** → CI에서는 `lint-staged` 대신 `npm run lint:all`/`npm run format --check`로 **전체 레포 **를
  확인하는 게 일반적이다.

## 자주 만나는 문제 & 참고

### “You are linting '.', but all files are ignored”

- 전체 스캔(`eslint .`)인데 `ignores`가 너무 광범위하면 발생
- **해결:** pre-commit용 `lint`는 `.` 없이, 전체 점검은 `lint:all`로 분리(이미 반영됨)

### 타입 기반 린트가 필요할 때

- `recommendedTypeChecked` + `parserOptions.project` 유지
- 성능 비용이 크므로 필요한 규칙만 부분 도입을 권장

### 모노레포 패키지별 tsconfig 적용

- 현재 설정은 `project: ['./tsconfig.json', './packages/*/tsconfig.json']`로 **루트+모든 패키지**를 한 번에 커버
- 새 패키지를 추가해도 자동으로 포함된다
- 성능 최적화가 필요하면 패키지별 `files` 블록으로 **명시 분리** 가능

## 마무리

- **ESLint**로 잠재 버그/품질 문제 조기 차단, **Prettier**로 스타일 통일
- Flat Config 기반의 단일 설정, 캐시 활성화로 빠르고 가볍게
- Husky + lint-staged로 **커밋 단계에서 자동 안전망** 구축
- 모노레포에서도 루트 한 곳에서 **일관된 품질 기준**을 유지
